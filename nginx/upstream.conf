# Step 1: Use split_clients to select a backend based on weight
split_clients "${http_x_forwarded_for}${request_uri}" $backend_server {
    22.00% backend-a-971441253898.europe-west1.run.app:443;  # server1 - Weight: 22
    61.00% backend-b-971441253898.europe-west1.run.app:443;  # server2 - Weight: 39
    *      backend-c-971441253898.europe-west1.run.app:443;  # server3 - Health: 0.980
}

# Step 2: Extract the hostname (without :443) for the Host header
map $backend_server $backend_host {
    backend-a-971441253898.europe-west1.run.app:443    backend-a-971441253898.europe-west1.run.app;
    backend-b-971441253898.europe-west1.run.app:443    backend-b-971441253898.europe-west1.run.app;
    backend-c-971441253898.europe-west1.run.app:443    backend-c-971441253898.europe-west1.run.app;
    default                                             $backend_server;
}